name: Deploy
on:
  workflow_dispatch:
    inputs:
      targets:
        description: '要部署的主机数组（JSON），例如 ["LOCAL30"]'
        required: true
        default: '["LOCAL30","LOCAL31","HK","SG"]'
      ref:
        required: true
        default: "master"

jobs:
  deploy:
    runs-on: self-hosted
    strategy:
      matrix:
        host: ${{ fromJson(inputs.targets) }}
      fail-fast: false
    env:
      GO_VERSION: "1.24.3"
      GOPROXY: "https://goproxy.cn,direct"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        run: |
          go mod download
          go build -o gotun ./cmd/main.go

      - name: Deploy to ${{ matrix.host }}
        env:
          SSH_HOST: ${{ secrets[format('SSH_HOST_{0}', matrix.host)] }}
          SSH_USER: ${{ secrets[format('SSH_USER_{0}', matrix.host)] || 'root' }}
          SSH_PORT: ${{ secrets[format('SSH_PORT_{0}', matrix.host)] || '22' }}
          SSH_PASS: ${{ secrets[format('SSH_PASSWORD_{0}', matrix.host)] }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass

          sshpass -p "$SSH_PASS" scp -P "$SSH_PORT" gotun "$SSH_USER@$SSH_HOST:/data/gotun/gotun.new"
          sshpass -p "$SSH_PASS" ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" <<'EOF'
          set -e
          sudo systemctl stop gotun
          cp /data/gotun/gotun /data/gotun/gotun.old
          mv /data/gotun/gotun.new /data/gotun/gotun
          sudo systemctl start gotun
          sudo systemctl status gotun --no-pager -l
          EOF
